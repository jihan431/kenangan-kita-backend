<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login - Kenangan Kita</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');

    /* Reset & base */
    *, *::before, *::after {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
      color: #2c3e50;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px 16px;
    }

    /* Login container */
    #login-container {
      background: rgba(255 255 255 / 0.9);
      padding: 40px 32px;
      border-radius: 16px;
      box-shadow: 0 16px 32px rgba(79, 70, 229, 0.25);
      width: 100%;
      max-width: 400px;
      display: flex;
      flex-direction: column;
      gap: 24px;
      text-align: center;
    }
    #login-container h2 {
      margin: 0;
      font-size: 2rem;
      font-weight: 700;
      color: #4f46e5;
    }
    #login-container p {
      margin: 0;
      font-weight: 500;
      color: #343a40;
    }
    #login-container label {
      font-weight: 600;
      font-size: 1rem;
      margin-bottom: 8px;
      display: block;
      color: #495057;
      text-align: left;
    }
    #password-input {
      width: 100%;
      padding: 12px 16px;
      font-size: 1rem;
      border-radius: 12px;
      border: 1.5px solid #ced4da;
      transition: border-color 0.3s ease;
    }
    #password-input:focus {
      outline: none;
      border-color: #4f46e5;
      box-shadow: 0 0 8px rgba(79, 70, 229, 0.35);
      background-color: #f8f9fa;
    }
    #login-button {
      padding: 14px 36px;
      background: linear-gradient(135deg, #6e56cf, #4f46e5);
      color: white;
      font-weight: 700;
      font-size: 1.1rem;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: 0 6px 12px rgba(79, 70, 229, 0.6);
      transition: background 0.3s ease;
    }
    #login-button:hover,
    #login-button:focus {
      background: linear-gradient(135deg, #5b44c3, #3e37be);
    }
    #error-message {
      color: #dc3545;
      font-weight: 600;
      min-height: 1.2rem;
      visibility: hidden;
      margin-top: -12px;
      margin-bottom: 12px;
      text-align: left;
    }

    /* Konten utama disembunyikan awalnya */
    #main-content {
      display: none;
      width: 100%;
      max-width: 700px;
      flex-direction: column;
      align-items: center;
      padding: 0 16px;
    }
    main {
      width: 100%;
    }
    header {
      text-align: center;
      margin-bottom: 32px;
    }
    header h1 {
      font-weight: 700;
      font-size: 2.75rem;
      margin-bottom: 8px;
      color: #343a40;
    }
    header p.subtitle {
      margin-top: 0;
      margin-bottom: 40px;
      font-weight: 500;
      font-size: 1.2rem;
      color: #495057;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }

    form#kenangan-form {
      background: rgba(255 255 255 / 0.85);
      padding: 24px 32px;
      border-radius: 16px;
      box-shadow: 0 12px 24px rgba(108, 117, 125, 0.15);
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin-bottom: 48px;
      width: 100%;
    }
    form#kenangan-form label {
      font-weight: 600;
      font-size: 1rem;
      color: #495057;
      margin-bottom: 8px;
      display: block;
    }
    form#kenangan-form input[type="date"],
    form#kenangan-form textarea,
    form#kenangan-form input[type="file"] {
      width: 100%;
      padding: 12px 16px;
      border-radius: 12px;
      border: 1.5px solid #ced4da;
      font-size: 1rem;
      font-family: 'Inter', sans-serif;
      transition: border-color 0.3s ease;
      resize: vertical;
      min-height: 80px;
    }
    form#kenangan-form input[type="date"]:focus,
    form#kenangan-form textarea:focus,
    form#kenangan-form input[type="file"]:focus {
      outline: none;
      border-color: #4f46e5;
      box-shadow: 0 0 8px rgba(79, 70, 229, 0.35);
      background-color: #f8f9fa;
    }
    form#kenangan-form button {
      align-self: flex-end;
      padding: 14px 36px;
      border: none;
      cursor: pointer;
      font-weight: 700;
      border-radius: 12px;
      font-size: 1.1rem;
      background: linear-gradient(135deg, #6e56cf, #4f46e5);
      color: white;
      box-shadow: 0 6px 12px rgba(79, 70, 229, 0.6);
      transition: background 0.3s ease;
    }
    form#kenangan-form button:hover,
    form#kenangan-form button:focus {
      background: linear-gradient(135deg, #5b44c3, #3e37be);
    }
    section.kenangan-list {
      display: grid;
      gap: 24px;
      width: 100%;
    }
    article.kenangan-card {
      background: rgba(255 255 255 / 0.9);
      border-radius: 16px;
      box-shadow: 0 8px 18px rgba(108, 117, 125, 0.12);
      padding: 24px 28px;
      color: #344054;
      display: flex;
      flex-direction: column;
      gap: 12px;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    article.kenangan-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 14px 28px rgba(79, 70, 229, 0.28);
    }
    .kenangan-date {
      font-weight: 600;
      font-size: 0.95rem;
      color: #6c757d;
      font-style: italic;
    }
    .kenangan-text {
      font-size: 1.125rem;
      line-height: 1.5;
      white-space: pre-line;
    }
    .kenangan-image {
      max-width: 100%;
      border-radius: 12px;
      margin-top: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
      object-fit: cover;
      height: auto;
      max-height: 400px;
      align-self: center;
    }
    #loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.75);
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      color: #4f46e5;
      z-index: 9999;
      font-weight: 700;
    }
    @media (max-width: 640px) {
      #login-container {
        padding: 28px 24px;
      }
      #login-container h2 {
        font-size: 1.6rem;
      }
      header h1 {
        font-size: 2rem;
      }
      form#kenangan-form {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <!-- Loading overlay -->
  <div id="loading-overlay" role="alert" aria-live="assertive" aria-busy="true" aria-label="Memuat, mohon tunggu...">Mengunggah foto, mohon tunggu...</div>

  <!-- Halaman Login -->
  <section id="login-container" role="main" aria-label="Halaman Login">
    <h2>Masuk ke Kenangan Kita</h2>
    <p>Masukkan password untuk melanjutkan</p>
    <form id="login-form" aria-label="Form login password">
      <label for="password-input">Password</label>
      <input
        type="password"
        id="password-input"
        name="password"
        aria-required="true"
        autocomplete="off"
        required
        autofocus
        aria-describedby="error-message"
      />
      <div id="error-message" role="alert" aria-live="assertive"></div>
      <button type="submit" id="login-button" aria-label="Masuk">Masuk</button>
    </form>
  </section>

  <!-- Konten Utama (disembunyikan awalnya) -->
  <section id="main-content" role="main" aria-label="Halaman penyimpanan kenangan">
    <header>
      <h1>Kenangan Kita</h1>
      <p class="subtitle">
        Simpan setiap momen indah bersama pasangan dengan kata-kata yang penuh makna
      </p>
    </header>
    <main>
      <form id="kenangan-form" aria-label="Formulir menambahkan kenangan" enctype="multipart/form-data">
        <label for="tanggal">Tanggal Kenangan</label>
        <input type="date" id="tanggal" name="tanggal" required aria-required="true" />
        <label for="pesan">Cerita atau Pesan Kenangan</label>
        <textarea
          id="pesan"
          name="pesan"
          rows="4"
          placeholder="Tuliskan kenanganmu di sini..."
          required
          aria-required="true"
        ></textarea>
        <label for="foto">Tambah Foto (opsional)</label>
        <input type="file" id="foto" name="foto" accept="image/*" aria-label="Unggah foto kenangan"/>
        <button type="submit" aria-label="Simpan kenangan">Simpan Kenangan</button>
      </form>
      <section
        aria-live="polite"
        aria-relevant="additions"
        class="kenangan-list"
        id="kenangan-list"
        aria-label="Daftar kenangan yang telah disimpan"
      >
        <!-- Kenangan cards akan ditampilkan di sini -->
      </section>
    </main>
  </section>

<script>
(() => {
  const PASSWORD   = "200225";
  const BASE_URL   = "http://localhost:5000";   // sesuaikan kalau port berbeda

  // Elemen‑elemen
  const loginC   = document.getElementById("login-container");
  const loginF   = document.getElementById("login-form");
  const passIn   = document.getElementById("password-input");
  const errMsg   = document.getElementById("error-message");

  const mainSec  = document.getElementById("main-content");
  const formKng  = document.getElementById("kenangan-form");
  const listKng  = document.getElementById("kenangan-list");
  const overlay  = document.getElementById("loading-overlay");

  let kenanganData = [];            // tidak lagi langsung pakai localStorage

  /* ----------  Util  ---------- */
  const fmtTgl = (t) =>
    new Date(t).toLocaleDateString("id-ID", {day:"numeric",month:"long",year:"numeric"});

  function renderList() {
    listKng.innerHTML = "";
    if (!kenanganData.length) {
      listKng.innerHTML =
        '<p style="color:#6c757d;font-style:italic;text-align:center">Belum ada kenangan.</p>';
      return;
    }
    kenanganData
      .slice()
      .sort((a,b)=> new Date(b.tanggal) - new Date(a.tanggal))
      .forEach(({tanggal,pesan,fotoURL}) => {
        const art = document.createElement("article");
        art.className = "kenangan-card";
        art.innerHTML = `
          <time datetime="${tanggal}" class="kenangan-date">${fmtTgl(tanggal)}</time>
          <p class="kenangan-text">${passthrough(pesan)}</p>
          ${fotoURL ? `<img src="${fotoURL}" alt="foto" class="kenangan-image">` : ""}
        `;
        listKng.appendChild(art);
      });
  }
  const passthrough = (str)=>str.replace(/\n/g,"<br>");

  /* ----------  Networking  ---------- */
  async function fetchKenangan() {
    const res = await fetch(`${BASE_URL}/kenangan`);
    kenanganData = await res.json();
    renderList();
  }

  async function postKenangan(payload) {
    const res = await fetch(`${BASE_URL}/kenangan`, {
      method : "POST",
      headers: {"Content-Type":"application/json"},
      body   : JSON.stringify(payload),
    });
    if (!res.ok) {
      const {error} = await res.json();
      throw new Error(error || "Gagal menyimpan");
    }
  }

  async function uploadToCatbox(file) {
    overlay.style.display = "flex";
    const fd = new FormData();
    fd.append("reqtype", "fileupload");
    fd.append("fileToUpload", file);
    try {
      const r = await fetch("https://catbox.moe/user/api.php", {method:"POST",body:fd});
      const txt = await r.text();
      if (!txt.startsWith("http")) throw new Error("URL tidak valid");
      return txt.trim();
    } finally {
      overlay.style.display = "none";
    }
  }

  /* ----------  Event: Login  ---------- */
  loginF.addEventListener("submit", async (e)=> {
    e.preventDefault();
    if (passIn.value.trim() !== PASSWORD) {
      errMsg.textContent = "Password salah.";
      errMsg.style.visibility = "visible";
      passIn.focus();
      return;
    }
    errMsg.style.visibility = "hidden";
    loginC.style.display = "none";
    mainSec.style.display = "flex";
    await fetchKenangan();
    setTimeout(()=>formKng.querySelector("input,textarea").focus(),100);
  });

  /* ----------  Event: Tambah kenangan  ---------- */
  formKng.addEventListener("submit", async (e)=>{
    e.preventDefault();
    const tanggal = formKng.tanggal.value;
    const pesan   = formKng.pesan.value.trim();
    if (!tanggal || !pesan) return alert("Lengkapi tanggal & pesan.");

    let fotoURL = "";
    const file = formKng.foto.files[0];
    if (file) {
      if (!file.type.startsWith("image/"))  return alert("File harus gambar.");
      if (file.size > 5*1024*1024)          return alert("Maks 5 MB.");
      fotoURL = await uploadToCatbox(file);
    }

    try {
      await postKenangan({tanggal, pesan, fotoURL});
      formKng.reset();
      await fetchKenangan();               // refresh list
    } catch(err) {
      alert(err.message);
    }
  });
})();
</script>

</body>
</html>

